# LitRelevanceAI 项目功能与架构概览（PyQt6）

## 文档导航

本架构概览是完整文档体系的一部分：

- **[CLAUDE.md](../CLAUDE.md)** - AI 助手指南，包含模式、工作流程和约定
- **[AGENTS.md](../AGENTS.md)** - 开发者指南（适用于人类和 AI 开发者）
- **[CODE_QUALITY_ACTION_PLAN.md](../CODE_QUALITY_ACTION_PLAN.md)** - 代码质量改进路线图
- **[IMPLEMENTATION_PROGRESS.md](../IMPLEMENTATION_PROGRESS.md)** - 实施进度跟踪
- **[ARCHITECTURE.md](ARCHITECTURE.md)** - 英文架构文档
- **[AI_ASSISTED_CONFIG_DESIGN.md](AI_ASSISTED_CONFIG_DESIGN.md)** - AI 辅助配置设计
- **[README.md](../README.md)** / **[Chinese_README.md](../Chinese_README.md)** - 用户文档

**AI 助手请从 CLAUDE.md 开始**，获取全面的开发指导。

---

本文档基于 `AGENTS.md` 与核心源码整理，帮助开发者快速了解 LitRelevanceAI 的能力与实现结构。

## 核心功能

- **CSV 文献相关度分析**：`litrx csv` 读取 Scopus 导出的 CSV，对每篇文献计算 0–100 的相关度分数，并生成适合文献综述的撰写建议。PyQt6 GUI 中提供结果表格、详情弹窗与导出功能；完成后自动保存结果到原文件夹（带时间戳）。  
- **可配置的标题/摘要筛选**：`litrx abstract` 支持命令行和 PyQt6 GUI。筛选问题源于 `questions_config.json` 中的模式定义，可对每个问题执行二次验证，支持状态写入 `<列名>_verified` 字段，GUI 日志用 ✔/✖ 标记；完成后自动保存结果。兼容 Zotero 列名（如 `Abstract Note`、`Short Title`）。  
- **文献矩阵分析（PDF）**：`litrx pdf`/`litrx matrix` 支持从 PDF 提取文本并按维度进行结构化分析，GUI Tab 支持批量文件、元数据匹配、仅元数据预检和结果目录打开。  
- **PyQt6 图形界面**：`python run_gui.py` 或 `python -m litrx --gui` 启动基于 PyQt6 的应用（CSV/Abstract/Matrix 三个标签页）。首次运行提供“首次启动引导”收集服务商与 API Key 并可保存到系统密钥环。
- **统一的配置体系**：所有命令合并 `.env`、YAML/JSON 配置与命令行参数得到 `DEFAULT_CONFIG`。GUI 的“保存配置”写入 `~/.litrx_gui.yaml` 并在启动时加载。  
- **易于分发**：提供 PyInstaller 构建脚本（Windows `.bat`、macOS `.sh`），可打包为“点开即用”的 `.exe/.app`。

## 代码架构

### 顶层入口与命令行调度
- `litrx/__main__.py` 支持 `python -m litrx`；`--gui` 直接启动 PyQt6 主界面，否则将剩余参数传递给 CLI 子命令解析器。  
- `litrx/cli.py` 定义 `csv`、`abstract`、`matrix` 等子命令；`abstract --gui` 也会启动 PyQt6 主界面。

### 核心功能模块
- **CSV 分析 (`litrx/csv_analyzer.py`)**：封装 `LiteratureAnalyzer`，负责读取 Scopus CSV、调用 `AIClient` 生成相关度评分与建议、实时保存分析结果。GUI 页在处理完成后自动保存结果。  
- **摘要筛选 (`litrx/abstract_screener.py`)**：加载 `questions_config.json` 中的模式问题，自动匹配标题/摘要列（含 Zotero `Abstract Note`/`Short Title`），按问题生成列与 `_verified` 字段，并可根据配置执行 AI 二次验证。  
- **矩阵分析 (`litrx/matrix_analyzer.py`)**：从 PDF 提取文本后进行结构化维度分析，支持智能元数据匹配与多题型维度。

### AI 客户端与配置管理
- `litrx/config.py` 统一处理 `.env`、YAML/JSON 与运行时配置合并，提供基础 `DEFAULT_CONFIG`。  
- `litrx/ai_client.py` 使用 OpenAI SDK（SiliconFlow 走兼容 API），初始化时缓存模型能力（如 GPT‑5/o* 禁用自定义 temperature）；请求前自动移除不被支持的参数，必要时做一次无 temperature 的兜底重试。

### GUI 结构（PyQt6）
- `litrx/gui/base_window_qt.py`：加载默认/持久化配置，提供服务切换、API Key 输入与保存、“首次启动引导”向导、Prompt 设置与日志查看等；维护 `QTabWidget` 用于挂载标签页。  
- `litrx/gui/main_window_qt.py`：注册 `CsvTab`、`AbstractTab`、`MatrixTab` 三个标签页，并提供 `launch_gui` 入口。  
- `run_gui.py`：PyQt6 启动器，首次运行可自动安装缺失依赖（包括 PyQt6）。

### 配置与资源文件
- `configs/config.yaml` 存放默认模型、服务和界面初始值；`configs/matrix/*.yaml` 为矩阵维度模板。  
- `questions_config.json` 保存摘要筛选模式定义（GUI 可新增/编辑模式与问题）。  
- `prompts_config.json` 保存各分析类型的 Prompt 模板（GUI 可编辑）。  
- `litrx/resources.py` 提供 `resource_path()`，在 PyInstaller 冻结后从 `_MEIPASS` 定位资源，开发时从仓库根目录读取。

## 项目结构与文件说明（按目录）

```
LitRelevanceAI/
├── run_gui.py                          # 启动 PyQt6 GUI 的便捷入口（自动安装缺依赖）
├── pyproject.toml                      # 包配置（依赖、脚本入口）
├── setup.cfg                           # 辅助工具配置
├── questions_config.json               # 摘要筛选的模式定义（可被 GUI 读写）
├── prompts_config.json                 # 统一 Prompt 模板（GUI 可编辑）
├── configs/
│   ├── config.yaml                     # GUI 基础默认配置（服务、模型、语言等）
│   └── matrix/
│       └── default.yaml                # 矩阵分析的默认维度 preset
├── packaging/
│   ├── build_win.bat                   # 一键构建 Windows 可执行应用（PyInstaller）
│   ├── build_mac.sh                    # 一键构建 macOS .app（PyInstaller）
│   └── pyinstaller/
│       └── litrx.spec                  # PyInstaller 打包 spec（收集 PyQt6、prompts、配置等）
├── docs/
│   ├── ARCHITECTURE.md                 # 英文架构说明（PyQt6-only）
│   ├── 项目功能与架构概览.md            # 本文（中文）
│   ├── AI_ASSISTED_CONFIG_DESIGN.md    # AI 辅助配置的需求与设计（PyQt6 + OpenAI SDK）
│   └── AI_ASSISTED_CONFIG_IMPLEMENTATION_PLAN.md # AI 辅助配置的实施计划
└── litrx/                              # 核心代码包
    ├── __init__.py                     # 包初始化
    ├── __main__.py                     # `python -m litrx` 入口（--gui 启动 GUI，否则走 CLI）
    ├── cli.py                          # CLI 调度（csv / abstract / matrix 子命令）
    ├── resources.py                    # 统一资源定位（resource_path，兼容打包）
    ├── i18n.py                         # 国际化（zh/en 词典 + 观察者机制）
    ├── config.py                       # 配置合并（config.yaml、~/.litrx_gui.yaml、.env、CLI）
    ├── ai_client.py                    # OpenAI SDK 封装（兼容 SiliconFlow；缓存模型能力）
    ├── csv_analyzer.py                 # CSV 相关性分析（读 CSV → 构造 Prompt → 解析 → 保存）
    ├── abstract_screener.py            # 摘要筛选（模式加载、验证、并发处理、自动列识别）
    ├── matrix_analyzer.py              # 矩阵分析（PDF→文本→维度填充；智能元数据匹配）
    ├── prompts/                        # LLM Prompt 模板（由对话框/生成器加载）
    │   ├── abstract_mode_generation.txt        # AI 生成“摘要筛选模式”的 Prompt 模板
    │   └── matrix_dimension_generation.txt     # AI 生成“矩阵维度”的 Prompt 模板
    └── gui/
        ├── base_window_qt.py           # PyQt6 基窗体（配置区、首次启动引导、Prompt 设置、日志、Tab 容器）
        ├── main_window_qt.py           # PyQt6 主窗体（注册 CSV/Abstract/Matrix 三个 Tab）
        ├── dialogs_qt/
        │   ├── ai_mode_assistant_qt.py         # “AI 助手（创建模式）”对话框（自然语言→模式 JSON）
        │   └── ai_matrix_assistant_qt.py       # “AI 助手（生成维度）”对话框（自然语言→维度 YAML）
        └── tabs_qt/
            ├── csv_tab.py              # CSV 分析 Tab（进度、表格预览、完成后自动保存+导出）
            ├── abstract_tab.py         # 摘要筛选 Tab（加载模式、执行分析、AI 助手创建新模式）
            └── matrix_tab.py           # 矩阵分析 Tab（维度管理、AI 生成维度、另存为 preset）
```

说明：
- `resources.py`：提供 `resource_path(*parts)`，开发态指向仓库根，打包后指向 `_MEIPASS`；所有读模板/配置的地方统一调用。
- `ai_client.py`：基于 OpenAI 官方 SDK；初始化时缓存模型能力（如 GPT‑5/o* 不支持 temperature），请求前自动剥离不被支持的参数，必要时重试一次无 temperature。
- `abstract_screener.py`：列识别包含 Zotero 常见列名（Abstract Note、Short Title）；支持二次验证（可在 GUI/配置中开关）；完成后自动保存。
- `tabs_qt/*`：所有 UI 更新通过主线程（signals/slots）；耗时任务在后台线程执行。
- `dialogs_qt/*`：AI 助手对话框只提交“用户需求描述”给模型，不上传文献内容；解析失败/网络失败均有可读提示与重试。

## 典型工作流概览
1. 用户通过 CLI 或 GUI 选择分析模式并加载配置：`config.py` 与 `.env`、`~/.litrx_gui.yaml` 合并生成最终配置。  
2. 模块根据配置初始化 `AIClient`，准备问题模板或列结构；若模型不支持某些参数（如 GPT‑5 的 temperature），客户端会自动调整。  
3. 对输入数据（CSV/摘要/PDF）逐条调用模型获取结果；摘要筛选可选做二次验证；矩阵分析支持智能元数据匹配。  
4. 结果写回 DataFrame 或表格；CSV/摘要 GUI 标签页在完成后自动保存至原文件夹，同时保留“导出”操作。  
5. 若以 PyInstaller 打包，资源模板由 `resource_path()` 统一定位，用户可直接运行 `.exe/.app`。
